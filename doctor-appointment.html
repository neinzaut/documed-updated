<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointment</title>
    <link rel="stylesheet" href="appointment.css">
    <link rel="icon" type="image/x-icon" href="logo_notext.png">
</head>
<body>
    <nav class="navbar">

        <div class="nav-logo">
            <img src="logo.png" alt="DocuMed Logo">
        </div>
        <div class="nav-links">
            <!-- Notification Icon -->
            <a href="#" class="nav-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none">
                    <path d="M5 19C4.71667 19 4.47934 18.904 4.288 18.712C4.09667 18.52 4.00067 18.2827 4 18C3.99934 17.7173 4.09534 17.48 4.288 17.288C4.48067 17.096 4.718 17 5 17H6V10C6 8.61667 6.41667 7.38767 7.25 6.313C8.08334 5.23834 9.16667 4.534 10.5 4.2V3.5C10.5 3.08334 10.646 2.72934 10.938 2.438C11.23 2.14667 11.584 2.00067 12 2C12.416 1.99934 12.7703 2.14534 13.063 2.438C13.3557 2.73067 13.5013 3.08467 13.5 3.5V4.2C14.8333 4.53334 15.9167 5.23767 16.75 6.313C17.5833 7.38834 18 8.61734 18 10V17H19C19.2833 17 19.521 17.096 19.713 17.288C19.905 17.48 20.0007 17.7173 20 18C19.9993 18.2827 19.9033 18.5203 19.712 18.713C19.5207 18.9057 19.2833 19.0013 19 19H5ZM12 22C11.45 22 10.9793 21.8043 10.588 21.413C10.1967 21.0217 10.0007 20.5507 10 20H14C14 20.55 13.8043 21.021 13.413 21.413C13.0217 21.805 12.5507 22.0007 12 22Z" fill="#B1B1B1"/>
                    </svg>
            </a>

            <!-- User Icon and Profile Name -->
            <div class="profile-container">
                <div class="profile">
                    <div class="user-icon">
                        <img src="doctor_profile.png" alt="Doctor Profile">
                    </div>
                    <div class="profile-name">
                        <h3>John Doe</h3>
                        <p>Doctor</p>
                    </div>
                </div>

                <!-- Dropdown for Logout -->
                <div class="dropdown">
                    <button class="dropdown-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M6 7L12 13L18 7L20 9L12 17L4 9L6 7Z" fill="black"/>
                        </svg>
                    </button>
                    <div class="dropdown-menu">
                        <a href="doctor-profile.html" class="dropdown-item">My Profile</a>
                        <a href="doctor-login.html" class="dropdown-item">Log out</a>
                    </div>
                </div>
            </div>

        </div>
    </nav>

    <nav class="menu" tabindex="0">
        <div class="smartphone-menu-trigger"></div>
        <header class="avatar">
            <img src="doctor_profile.png" />
            <h2>John D.</h2>
        </header>
        <ul>
            <li tabindex="0" class="icon-dashboard">
                <img src="home-icon.png" alt="Home Icon" style="width:20px; height:20px; margin-right:10px;">
                <a href="doctor-dashboard.html"><span>Home</span></a>
            </li>
            <li tabindex="0" class="icon-customers">
                <img src="records-icon.png" alt="Records Icon" style="width:20px; height:20px; margin-right:10px;">
                <a href="doctor-records.html"><span>Records</span></a>
            </li>
            <li tabindex="0" class="icon-users">
                <img src="appointment-icon.png" alt="Appointment Icon" style="width:20px; height:20px; margin-right:10px;">
                <a href="doctor-appointment.html"><span>Appointment</span></a>
            </li>
            <!-- <li tabindex="0" class="icon-users">
                <img src="inventory-icon.png" alt="Inventory Icon" style="width:20px; height:20px; margin-right:10px;">
                <a href="doctor-inventory.html"><span>Inventory</span></a>
            </li> -->
            <!-- <li tabindex="0" class="icon-settings">
                <img src="doctor_profile.png" alt="Logout Icon" style="width:20px; height:20px; margin-right:10px;">
                <span>Log out</span>
            </li> -->
        </ul>
    </nav>

    <div class="main-container">
        <div class="content">
            <h1>Appointment Calendar</h1>
            <div class="main">
                <div class="appointment-container">
                    <!-- Calendar and Requests Section -->
                    <div class="top-section">
                        <div class="calendar-section">
                            <div class="calendar-wrapper">
                                <div class="calendar-header">
                                    <button id="prevMonth"><</button>
                                    <h3 id="monthDisplay"></h3>
                                    <button id="nextMonth">></button>
                                </div>
                                <div class="weekdays">
                                    <div>Sun</div>
                                    <div>Mon</div>
                                    <div>Tue</div>
                                    <div>Wed</div>
                                    <div>Thu</div>
                                    <div>Fri</div>
                                    <div>Sat</div>
                                </div>
                                <div id="calendar" class="calendar-grid"></div>
                            </div>
                        </div>

                        <div class="requests-section">
                            <h2>Patient Requests <button id="view-more-btn">View more</button></h2>
                            <div class="request-list">
                                <div id="requests-loading" class="loading-spinner">
                                    <div class="spinner"></div>
                                    <span>Loading requests...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Appointments Table Section -->
                    <div class="appointments-section">
                        <h2>Appointments Overview</h2>
                        <div id="appointments-loading" class="loading-spinner">
                            <div class="spinner"></div>
                            <span>Loading appointments...</span>
                        </div>
                        <table class="appointments-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Patient ID</th>
                                    <th>Patient Name</th>
                                    <th>Clinic</th>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Type of Visit</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Table content will be dynamically populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for additional requests -->
    <div id="requestModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Additional Patient Requests</h2>
            <div class="additional-requests">
                <!-- Additional requests will be dynamically added here -->
            </div>
        </div>
    </div>

<script>
let currentDate = new Date();
let currentMonth = currentDate.getMonth();
let currentYear = currentDate.getFullYear();
const doctorId = 1; // This should be dynamically set based on logged-in doctor

const monthNames = ["January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"];

// Update the fetchPatientRequests function
async function fetchPatientRequests() {
    const requestList = document.querySelector('.request-list');
    if (!requestList) return;

    try {
        requestList.innerHTML = '<div class="loading-message">Loading requests...</div>';
        
        const response = await fetch(`http://localhost:5000/appointments/pending/${doctorId}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const pendingRequests = await response.json();
        
        requestList.innerHTML = '';
        
        if (!Array.isArray(pendingRequests)) {
            throw new Error('Expected array of requests but got ' + typeof pendingRequests);
        }

        if (pendingRequests.length === 0) {
            requestList.innerHTML = '<div class="no-requests">No pending requests</div>';
            return;
        }

        pendingRequests.forEach(request => {
            const requestCard = document.createElement('div');
            requestCard.className = 'request-card';
            requestCard.innerHTML = `
                <div class="patient-info">
                    <h3>${request.patient_name}</h3>
                    <p class="student-id">Student ID: ${request.student_id}</p>
                    <p class="contact">Contact: ${request.contact_number}</p>
                </div>
                <div class="appointment-info">
                    <p><strong>Clinic:</strong> ${request.clinic}</p>
                    <p><strong>Date:</strong> ${new Date(request.appointment_date).toLocaleDateString()}</p>
                    <p><strong>Time:</strong> ${request.appointment_time}</p>
                    <p><strong>Visit Type:</strong> ${request.type_of_visit}</p>
                    <p class="request-time"><small>Requested on: ${new Date(request.created_at).toLocaleString()}</small></p>
                </div>
                <div class="request-actions">
                    <button onclick="updateAppointmentStatus(${request.id}, 'Confirmed')" class="confirm-btn">Confirm</button>
                    <button onclick="updateAppointmentStatus(${request.id}, 'Rejected')" class="reject-btn">Reject</button>
                </div>
            `;
            requestList.appendChild(requestCard);
        });
    } catch (error) {
        console.error('Error fetching requests:', error);
        requestList.innerHTML = `<div class="error-message">Error loading requests: ${error.message}</div>`;
    }
}

// Function to update appointment status
async function updateAppointmentStatus(appointmentId, status) {
    try {
        const response = await fetch(`http://localhost:5000/appointments/${appointmentId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status })
        });
        
        if (response.ok) {
            // Refresh both the requests and calendar
            fetchPatientRequests();
            renderCalendar();
            // Also refresh the appointments table
            fetchAppointmentsOverview();
        }
    } catch (error) {
        console.error('Error updating appointment:', error);
    }
}

// Function to fetch appointments overview
async function fetchAppointmentsOverview() {
    const tableBody = document.querySelector('.appointments-table tbody');
    if (!tableBody) return; // Guard clause if element doesn't exist

    try {
        tableBody.innerHTML = '<tr><td colspan="9" class="loading-message">Loading appointments...</td></tr>';
        
        const response = await fetch(`http://localhost:5000/appointments/overview/${doctorId}`);
        const appointments = await response.json();
        
        tableBody.innerHTML = ''; // Clear loading message
        
        appointments.forEach(appointment => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${appointment.id}</td>
                <td>${appointment.patient_id}</td>
                <td>${appointment.patient_name}</td>
                <td>${appointment.clinic}</td>
                <td>${new Date(appointment.appointment_date).toLocaleDateString()}</td>
                <td>${appointment.appointment_time}</td>
                <td>${appointment.type_of_visit}</td>
                <td><span class="status-${appointment.status.toLowerCase()}">${appointment.status}</span></td>
                <td class="action-buttons">
                    <button class="edit-btn" onclick="editAppointment(${appointment.id})">Edit</button>
                    <button class="cancel-btn" onclick="updateAppointmentStatus(${appointment.id}, 'Rejected')">Cancel</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
        
        return appointments;
    } catch (error) {
        console.error('Error fetching appointments:', error);
        tableBody.innerHTML = `
            <tr>
                <td colspan="9" class="error-message">
                    Error loading appointments. Please try again later.
                </td>
            </tr>
        `;
    }
}

async function renderCalendar() {
    const firstDay = new Date(currentYear, currentMonth, 1);
    const lastDay = new Date(currentYear, currentMonth + 1, 0);
    const startingDay = firstDay.getDay();
    const totalDays = lastDay.getDate();

    const calendar = document.getElementById('calendar');
    const monthDisplay = document.getElementById('monthDisplay');

    monthDisplay.textContent = `${monthNames[currentMonth]} ${currentYear}`;
    calendar.innerHTML = '';

    // Fetch confirmed appointments for the current month
    const appointments = await fetchAppointmentsOverview();
    const confirmedAppointments = appointments ? appointments.filter(a => 
        a.status === 'Confirmed' && 
        new Date(a.appointment_date).getMonth() === currentMonth &&
        new Date(a.appointment_date).getFullYear() === currentYear
    ) : [];

    // Add empty cells for days before the first day of the month
    for(let i = 0; i < startingDay; i++) {
        calendar.innerHTML += '<div></div>';
    }

    // Add days of the month
    for(let day = 1; day <= totalDays; day++) {
        const dateCell = document.createElement('div');
        dateCell.textContent = day;

        // Check if this day has any confirmed appointments
        const hasAppointment = confirmedAppointments.some(appointment => {
            const appointmentDate = new Date(appointment.appointment_date);
            return appointmentDate.getDate() === day;
        });

        if (hasAppointment) {
            dateCell.classList.add('has-appointment');
        }

        // Add special styling for today's date
        if(day === currentDate.getDate() && currentMonth === currentDate.getMonth() && currentYear === currentDate.getFullYear()) {
            dateCell.classList.add('selected');
        }

        calendar.appendChild(dateCell);
    }
}

document.getElementById('prevMonth').addEventListener('click', () => {
    currentMonth--;
    if(currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
    }
    renderCalendar();
});

document.getElementById('nextMonth').addEventListener('click', () => {
    currentMonth++;
    if(currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
    }
    renderCalendar();
});

// Initialize everything when the page loads
document.addEventListener('DOMContentLoaded', () => {
    fetchPatientRequests();
    renderCalendar();
});

// Add editAppointment function
function editAppointment(appointmentId) {
    // Implement edit functionality
    console.log('Edit appointment:', appointmentId);
    alert('Edit functionality will be implemented soon.');
}
</script>

<style>
/* Add styles for appointment indicators */
.has-appointment {
    background-color: #e3f2fd;
    position: relative;
}

.has-appointment::after {
    content: '';
    position: absolute;
    bottom: 2px;
    left: 50%;
    transform: translateX(-50%);
    width: 4px;
    height: 4px;
    background-color: #0A8EF3;
    border-radius: 50%;
}

.request-card {
    background: white;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.request-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.confirm-btn {
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
}

.reject-btn {
    background-color: #f44336;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
}

.loading-spinner {
    text-align: center;
    padding: 20px;
    color: #666;
}

.status-confirmed {
    color: #4CAF50;
    font-weight: bold;
}

.status-pending {
    color: #FFA000;
    font-weight: bold;
}

.status-rejected {
    color: #f44336;
    font-weight: bold;
}

/* Add spinner animation */
.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #0A8EF3;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-spinner {
    text-align: center;
    padding: 20px;
    display: none;
}

.loading-spinner span {
    display: block;
    margin-top: 10px;
    color: #666;
}

/* Update table styles */
.appointments-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background: white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.appointments-table th,
.appointments-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.appointments-table th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: #333;
}

.appointments-table tr:hover {
    background-color: #f5f5f5;
}

.status-confirmed {
    color: #4CAF50;
    font-weight: 600;
}

.status-pending {
    color: #FFA000;
    font-weight: 600;
}

.status-rejected {
    color: #f44336;
    font-weight: 600;
}

.action-buttons {
    display: flex;
    gap: 8px;
}

.edit-btn, .cancel-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s;
}

.edit-btn {
    background-color: #0A8EF3;
    color: white;
}

.cancel-btn {
    background-color: #f44336;
    color: white;
}

.edit-btn:hover {
    background-color: #0056b3;
}

.cancel-btn:hover {
    background-color: #d32f2f;
}

/* Add these new styles */
.loading-message {
    text-align: center;
    padding: 20px;
    color: #666;
}

.error-message {
    text-align: center;
    padding: 20px;
    color: #f44336;
}

.no-requests {
    text-align: center;
    padding: 20px;
    color: #666;
    font-style: italic;
}

/* Update table header */
.appointments-table thead tr {
    background-color: #f8f9fa;
}

.appointments-table th {
    padding: 12px;
    font-weight: 600;
    text-align: left;
    border-bottom: 2px solid #dee2e6;
}

/* Request card styles */
.request-card {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.request-card h3 {
    margin: 0 0 10px 0;
    color: #333;
}

.request-card p {
    margin: 5px 0;
    color: #666;
}

.request-actions {
    margin-top: 15px;
    display: flex;
    gap: 10px;
}

.patient-info {
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
    margin-bottom: 10px;
}

.patient-info h3 {
    color: #0A8EF3;
    margin: 0 0 5px 0;
}

.student-id, .contact {
    color: #666;
    font-size: 0.9em;
    margin: 2px 0;
}

.appointment-info {
    margin: 10px 0;
}

.appointment-info p {
    margin: 5px 0;
}

.request-time {
    color: #888;
    font-size: 0.8em;
    text-align: right;
    margin-top: 10px;
}

.request-card {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
}

.request-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.request-actions {
    margin-top: 15px;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}
</style>
</body>
</html>
